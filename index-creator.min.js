var v=!1,f=!0;function N(e,t=!0){let r=e.trim().split(`
`).map(o=>o.trim());if(r.length<1)return[];let s,n;t?(s=r[0].replace(/^\||\|$/g,"").split("|").map(o=>o.trim()),n=r.slice(2)):(s=["term","sub-term","notes","book","page"],n=r);let a=n.map(o=>{let i=o.replace(/^\||\|$/g,"").split("|").map(l=>l.trim()),c={};return s.forEach((l,u)=>{c[l]=i[u]||""}),c});return a.forEach(o=>{(o.term?.trim()||"").startsWith("?")&&(o._ignore=!0)}),a}function P(e){let t={},r=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let s of e)for(let n of["term","sub-term","notes"]){let a=s[n]||"",o;for(;(o=r.exec(a))!==null;){let i=(o[1]||o[2]||o[3]||"").toLowerCase().trim(),c="";o[5]?c=o[5].trim():o[6]?c=o[6].trim():o[7]&&(c=o[7].trim()),i&&c&&(t[i]=c)}}return t}function M(e){let t=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let r of e)for(let s of["term","sub-term","notes"])r[s]&&(r[s]=r[s].replace(t,(n,a,o,i)=>a||o||i||""))}function j(e,t){for(let r of e)["term","sub-term","notes"].forEach(s=>{let n=r[s]||"",a={};for(let o of Object.keys(t)){let i=new RegExp(`\\!\\b${R(o)}\\b`,"gi");n=n.replace(i,c=>{let l=`temp_placeholder_${o.toUpperCase()}`;return a[l]=c.slice(1),l})}for(let[o,i]of Object.entries(t)){let c=new RegExp(`\\b${R(o)}\\b`,"gi");n=n.replace(c,l=>V(l,i))}for(let[o,i]of Object.entries(a)){let c=new RegExp(R(o),"g");n=n.replace(c,i)}r[s]=n})}function O(e){let t=[];for(let r of e){let s=(r.term||"").trim(),n=(r["sub-term"]||"").trim();if(!(s.includes("<>")||n.includes("<>"))){t.push(r);continue}let o=s.replace(/<>/g,"").trim(),i=n.replace(/<>/g,"").trim();t.push({...r,term:o,"sub-term":i,_ignore:r._ignore||!1}),t.push({...r,term:i,"sub-term":o,_ignore:r._ignore||!1})}return t}function J(e){let t=[];for(let r of e){let n=["term","sub-term","notes","book","page"].map(u=>{let d=r[u]||"";return d.includes("&&")?d.split("&&").map(p=>p.trim()):[d.trim()]}),[a,o,i,c,l]=n;for(let u of a)for(let d of o)for(let p of i)for(let g of c)for(let m of l)t.push({term:u,"sub-term":d,notes:p,book:g,page:m,_ignore:r._ignore||!1})}return t}function U(e){let t={};e.forEach((r,s)=>{if(!r._ignore){for(let n of["term","sub-term","notes","book","page"]){let a=(r[n]||"").trim();(n==="term"&&a===""||a==="^^")&&(r[n]=t[n]||"")}t={...r}}})}function H(e){let t=[],r={term:"",subTerm:"",notes:"",book:0,page:""};for(let s of e){if(s._ignore)continue;let n=(s.term||"").trim(),a=(s["sub-term"]||"").trim(),o=(s.notes||"").trim(),i=(s.book||"").trim(),c=(s.page||"").trim(),l=n!=="",u=a!=="",d=o!=="",p=i!=="",g=c!=="",m=n,b=a,w=o,y=p?parseInt(i):0,E=g?T(c):r.page;l&&!u&&!d&&!p&&!g?(m=n,b="",w="",y=r.book,E=r.page):!l&&u&&!d&&!p&&!g?(m=r.term,b=a,w="",y=r.book,E=r.page):(m=n,b=a,w=o,y=p?parseInt(i):r.book,E=g?T(c):r.page);let h={term:m,subTerm:b,notes:w,book:y,page:E};t.push(h),r=h}return t.sort((s,n)=>{let a=C(s.term).localeCompare(C(n.term));if(a!==0)return a;let o=C(s.subTerm).localeCompare(C(n.subTerm));if(o!==0)return o;let i=$(s.page),c=$(n.page);return i-c}),t}function S(e,t){let r=document.createElement("table"),s=[];if(t){let n=0;for(;n<e.length;){let a=e[n];if(a.divider){s.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${a.divider}</strong></td>
    </tr>
  `),n++;continue}let o=e.slice(n).filter(c=>c.term===a.term),i=o.length;for(let c=0;c<i;){let l=e[n+c],d=o.slice(c).filter(m=>m.subTerm===l.subTerm).length,p=c===0?`<td rowspan="${i}">${_(l.term)}</td>`:"",g=d>1?`<td rowspan="${d}">${_(l.subTerm)}</td>`:`<td>${_(l.subTerm)}</td>`;s.push(`
          <tr>
            ${p}
            ${g}
            <td>${_(l.notes)}</td>
            <td>${l.book}</td>
            <td>${B(_(l.page))}</td>


          </tr>
        `);for(let m=1;m<d;m++){let b=e[n+c+m];s.push(`
            <tr>
              <td>${_(b.notes)}</td>
              <td>${b.book}</td>
              <td>${b.page}</td>
            </tr>
          `)}c+=d}n+=i}}else e.forEach(n=>{if(n.divider){s.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${n.divider}</strong></td>
      </tr>
    `);return}s.push(`
        <tr>
          <td>${_(n.term)}</td>
          <td>${_(n.subTerm)}</td>
          <td>${_(n.notes)}</td>
          <td>${n.book}</td>
          <td>${B(_(n.page))}</td>


        </tr>
      `)});r.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${s.join("")}
    </tbody>
  `,r.style.fontSize=`${x()}px`,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(r),Q(),X()}function V(e,t){let r=e===e.toUpperCase(),s=e[0]===e[0].toUpperCase(),n=t.split(/\b/),a=!1;return n.map(o=>/[A-Z]{2,}/.test(o)?o:r?o.charAt(0).toUpperCase()+o.slice(1).toLowerCase():s&&!a&&/[a-zA-Z]/.test(o)?(a=!0,o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()):o.toLowerCase()).join("")}function B(e){return e.split(",").map(t=>`<span class="page-segment">${t.trim()}</span>`).join(", ")}function T(e){return e?e.split(",").map(t=>t.trim()).sort((t,r)=>{let s=$(t),n=$(r);return s-n}).join(", "):""}function C(e){return e?e.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function $(e){let r=L(String(e||"")).match(/\d+/g);if(!r)return Number.MAX_SAFE_INTEGER;let s=r.map(n=>parseInt(n,10));return Math.min(...s)}function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function L(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function q(e){let t=e[0]||"",r=e[1]||"";return t.includes("|")&&r.match(/^(\|?[\s-]+\|?)+$/)}function K(e){let t=["term","sub-term","notes","book","page"],r=e.split(",").map(s=>s.trim().toLowerCase());return t.every(s=>r.includes(s))}function W(e){let t=F(e,!0),{rows:r,meta:s}=t;typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(r)));let n=A(e,{format:"csv",hasHeaders:!0});return typeof document<"u"&&(currentRenderedData=[],v=!1,document.getElementById("index_input").value=G(r),currentRenderedData=v?I(n):n,f=!0,S(currentRenderedData,f),typeof D=="function"&&D(s||{})),n}function G(e){let t=["term","sub-term","notes","book","page"],r=[t];for(let s of e){let n=t.map(a=>Z(s[a]||""));r.push(n)}return r.map(s=>s.join(",")).join(`
`)}function Z(e){let t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function D(e={}){if(document.getElementById("meta_title").value=e.title||"",document.getElementById("meta_css").value=e.customCSS||"",e.fontSize&&!isNaN(e.fontSize)){let t=document.getElementById("print_font_size");if(t){t.value=e.fontSize;let r=document.querySelector("#output table");r&&(r.style.fontSize=`${e.fontSize}px`)}}if(typeof e.collapsed=="boolean"){f=e.collapsed;let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields")}if(e.hasDividers&&Array.isArray(currentRenderedData)){currentRenderedData=I(currentRenderedData),v=!0;let t=document.getElementById("insert_dividers_button");t&&(t.textContent="Remove Letter Dividers")}else v=!1;Array.isArray(currentRenderedData)&&S(currentRenderedData,f)}function Q(){document.getElementById("save_to_csv_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block"}function X(){let e=document.getElementById("insert_dividers_button");e&&(e.textContent=v?"Remove Letter Dividers":"Insert Letter Dividers");let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand Duplicate Fields":"Collapse Duplicate Fields");let r=document.getElementById("print_font_size"),s=document.querySelector("#output table");r&&s&&(s.style.fontSize=`${x()}px`)}function I(e){if(!Array.isArray(e))return e;let t=[],r=null;for(let s of e){if(s._ignore||s.divider){t.push(s);continue}let n=L(s.term).charAt(0).toUpperCase();n!==r&&(t.push({divider:n}),r=n),t.push(s)}return t}function x(){let e=document.getElementById("print_font_size"),t=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(t)?10:t))}function Y(){function e(i){let c=["Term","Sub-term","Notes","Book","Page"],u=(typeof globalThis<"u"&&globalThis.originalParsedRows||[]).filter(h=>!h._ignore).map(h=>[h.term||"",h["sub-term"]||"",h.notes||"",h.book||"",h.page||""]),d=t(),p=[`?meta: ${JSON.stringify(d)}`],m=[c,p,...u].map(h=>h.map(z=>`"${String(z).replace(/"/g,'""')}"`).join(",")).join(`
`),b=new Blob([m],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(b),y=document.createElement("a");y.href=w;let E=(d.title||"index").replace(/[^\w-]+/g,"_");y.download=`${E}.csv`,y.style.display="none",document.body.appendChild(y),y.click(),document.body.removeChild(y)}function t(){return{title:document.getElementById("meta_title")?.value?.trim()||null,customCSS:document.getElementById("meta_css")?.value?.trim()||null,fontSize:parseInt(document.getElementById("print_font_size")?.value,10)||null,collapsed:!!f,hasDividers:currentRenderedData?.some(i=>i.divider)||!1}}function r(){let i=document.getElementById("import_csv_file");i&&i.addEventListener("change",c=>{let l=c.target.files?.[0];if(!l)return;let u=new FileReader;u.onload=()=>{let d=u.result;W(d),i.value=""},u.readAsText(l)})}r();let s=document.getElementById("import_csv_button"),n=document.getElementById("import_csv_file");s&&n&&s.addEventListener("click",()=>{n.click()});let a=document.getElementById("insert_dividers_button");a?.addEventListener("click",()=>{v=!currentRenderedData.some(c=>c.divider),v?(currentRenderedData=I(currentRenderedData),a.textContent="Remove Letter Dividers"):(currentRenderedData=currentRenderedData.filter(c=>!c.divider),a.textContent="Insert Letter Dividers"),S(currentRenderedData,f)}),document.getElementById("save_to_csv_button").onclick=()=>e(currentRenderedData,f),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{f=!f,document.getElementById("toggle_collapse_button").textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields",S(currentRenderedData,f)});function o(){let i=document.getElementById("print_font_size"),c=document.getElementById("increase_font"),l=document.getElementById("decrease_font"),u=document.getElementById("print_button");function d(p){let g=Math.max(1,Math.min(200,parseInt(p,10)||10));i.value=g;let m=`table {font-size: ${g}px;}`;u.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: '${m}'})`);let b=document.querySelector("#output table");b&&(b.style.fontSize=`${g}px`)}i.addEventListener("input",()=>d(i.value)),c.addEventListener("click",()=>d(+i.value+1)),l.addEventListener("click",()=>d(+i.value-1)),d(i.value)}o(),window.addEventListener("keydown",i=>{let c=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((c&&i.metaKey||!c&&i.ctrlKey)&&i.key.toLowerCase()==="p"){i.preventDefault();let d=`table {font-size: ${x()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:d})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let i=document.getElementById("index_input").value,c=A(i);currentRenderedData=v?I(c):c,S(currentRenderedData,f)})}function k(e){let t=[],r="",s=!1,n=0;for(;n<e.length;){let a=e[n];s?a==='"'?e[n+1]==='"'?(r+='"',n+=2):(s=!1,n++):(r+=a,n++):a==='"'?(s=!0,n++):a===","?(t.push(r.trim()),r="",n++):(r+=a,n++)}return t.push(r.trim()),t}function F(e,t=!0){let r=e.trim().split(`
`).map(i=>i.trim());if(r.length<1)return{rows:[],meta:null};let s,n,a=null;if(t?(s=k(r[0]).map(i=>i.trim().toLowerCase()),n=r.slice(1)):(s=["term","sub-term","notes","book","page"],n=r),n.length>0){let i=n[0],c=k(i)[0];if(c&&c.startsWith("?meta:")){try{let l=c.replace(/^\?meta:\s*/,"");a=JSON.parse(l)}catch{}n.shift()}}return{rows:n.map(i=>{let c=k(i),l={};return s.forEach((d,p)=>{l[d]=c[p]||""}),(l.term?.trim()||"").startsWith("?")&&(l._ignore=!0),l}),meta:a}}function A(e,t={}){let r=e.trim(),s=r.split(`
`),n=t.format||(r.includes(",")&&!r.includes("|")?"csv":"markdown"),a="hasHeaders"in t?t.hasHeaders:n==="markdown"?q(s):K(s[0]),o;if(n==="markdown")o=N(r,a);else if(n==="csv"){let u=F(r,a);o=u.rows,meta=u.meta}typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(o)));let i=P(o);M(o),j(o,i),U(o);let c=O(o),l=J(c);return H(l)}typeof document<"u"&&Y();
