var S=!1,f=!0;function j(e,t=!0){let n=e.trim().split(`
`).map(s=>s.trim());if(n.length<1)return[];let o,r;t?(o=n[0].replace(/^\||\|$/g,"").split("|").map(s=>s.trim()),r=n.slice(2)):(o=["term","sub-term","notes","book","page"],r=n);let a=r.map(s=>{let i=s.replace(/^\||\|$/g,"").split("|").map(l=>l.trim()),c={};return o.forEach((l,u)=>{c[l]=i[u]||""}),c});return a.forEach(s=>{(s.term?.trim()||"").startsWith("?")&&(s._ignore=!0)}),a}function O(e){let t={},n=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let o of e)for(let r of["term","sub-term","notes"]){let a=o[r]||"",s;for(;(s=n.exec(a))!==null;){let i=(s[1]||s[2]||s[3]||"").toLowerCase().trim(),c="";s[5]?c=s[5].trim():s[6]?c=s[6].trim():s[7]&&(c=s[7].trim()),i&&c&&(t[i]=c)}}return t}function J(e){let t=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let n of e)for(let o of["term","sub-term","notes"])n[o]&&(n[o]=n[o].replace(t,(r,a,s,i)=>a||s||i||""))}function U(e,t){for(let n of e)["term","sub-term","notes"].forEach(o=>{let r=n[o]||"",a={};for(let s of Object.keys(t)){let i=new RegExp(`\\!\\b${R(s)}\\b`,"gi");r=r.replace(i,c=>{let l=`temp_placeholder_${s.toUpperCase()}`;return a[l]=c.slice(1),l})}for(let[s,i]of Object.entries(t)){let c=new RegExp(`\\b${R(s)}\\b`,"gi");r=r.replace(c,l=>{let u=W(l,i);return`<span class="${`abbr-${$(s)}`}">${u}</span>`})}for(let[s,i]of Object.entries(a)){let c=new RegExp(R(s),"g");r=r.replace(c,i)}n[o]=r})}function H(e){let t=[];for(let n of e){let o=(n.term||"").trim(),r=(n["sub-term"]||"").trim();if(!(o.includes("<>")||r.includes("<>"))){t.push(n);continue}let s=o.replace(/<>/g,"").trim(),i=r.replace(/<>/g,"").trim();t.push({...n,term:s,"sub-term":i,_ignore:n._ignore||!1}),t.push({...n,term:i,"sub-term":s,_ignore:n._ignore||!1})}return t}function V(e){let t=[];for(let n of e){let r=["term","sub-term","notes","book","page"].map(u=>{let d=n[u]||"";return d.includes("&&")?d.split("&&").map(m=>m.trim()):[d.trim()]}),[a,s,i,c,l]=r;for(let u of a)for(let d of s)for(let m of i)for(let b of c)for(let g of l)t.push({term:u,"sub-term":d,notes:m,book:b,page:g,_ignore:n._ignore||!1})}return t}function q(e){let t={};e.forEach((n,o)=>{if(!n._ignore){for(let r of["term","sub-term","notes","book","page"]){let a=(n[r]||"").trim();(r==="term"&&a===""||a==="^^")&&(n[r]=t[r]||"")}t={...n}}})}function K(e){let t=[],n={term:"",subTerm:"",notes:"",book:0,page:""};for(let o of e){if(o._ignore)continue;let r=(o.term||"").trim(),a=(o["sub-term"]||"").trim(),s=(o.notes||"").trim(),i=(o.book||"").trim(),c=(o.page||"").trim(),l=r!=="",u=a!=="",d=s!=="",m=i!=="",b=c!=="",g=r,v=a,w=s,p=m?parseInt(i):0,y=b?F(c):n.page;l&&!u&&!d&&!m&&!b?(g=r,v="",w="",p=n.book,y=n.page):!l&&u&&!d&&!m&&!b?(g=n.term,v=a,w="",p=n.book,y=n.page):(g=r,v=a,w=s,p=m?parseInt(i):n.book,y=b?F(c):n.page);let h={term:g,subTerm:v,notes:w,book:p,page:y};t.push(h),n=h}return t.sort((o,r)=>{let a=C(o.term).localeCompare(C(r.term));if(a!==0)return a;let s=C(o.subTerm).localeCompare(C(r.subTerm));if(s!==0)return s;let i=I(o.page),c=I(r.page);return i-c}),t}function z(e){document.getElementById("custom-style").textContent=e||""}function $(e){return(String(e)||"").toLowerCase().replace(/[`*\\]/g,"").replace(/[^a-z0-9_-]+/g,"-").replace(/^-+|-+$/g,"").replace(/--+/g,"-")}function E(e,t){let n=document.createElement("table"),o=[];if(t){let r=0;for(;r<e.length;){let a=e[r];if(a.divider){o.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${a.divider}</strong></td>
    </tr>
  `),r++;continue}let s=e.slice(r).filter(c=>c.term===a.term),i=s.length;for(let c=0;c<i;){let l=e[r+c],d=s.slice(c).filter(p=>p.subTerm===l.subTerm).length,m=c===0?`<td rowspan="${i}">${_(l.term)}</td>`:"",b=d>1?`<td rowspan="${d}">${_(l.subTerm)}</td>`:`<td>${_(l.subTerm)}</td>`,g=$(l.term),v=$(l.subTerm),w=$(l.book);o.push(`
          <tr class="term-${g} subterm-${v} book-${w}">
            ${m}
            ${b}
            <td>${_(l.notes)}</td>
            <td>${l.book}</td>
            <td>${L(_(l.page))}</td>


          </tr>
        `);for(let p=1;p<d;p++){let y=e[r+c+p];o.push(`
            <tr>
              <td>${_(y.notes)}</td>
              <td>${y.book}</td>
              <td>${y.page}</td>
            </tr>
          `)}c+=d}r+=i}}else e.forEach(r=>{if(r.divider){o.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${r.divider}</strong></td>
      </tr>
    `);return}o.push(`
        <tr>
          <td>${_(r.term)}</td>
          <td>${_(r.subTerm)}</td>
          <td>${_(r.notes)}</td>
          <td>${r.book}</td>
          <td>${L(_(r.page))}</td>


        </tr>
      `)});n.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${o.join("")}
    </tbody>
  `,n.style.fontSize=`${B()}px`,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(n),ee(),te()}function W(e,t){let n=e===e.toUpperCase(),o=e[0]===e[0].toUpperCase(),r=t.split(/\b/),a=!1;return r.map(s=>/[A-Z]{2,}/.test(s)?s:n?s.charAt(0).toUpperCase()+s.slice(1).toLowerCase():o&&!a&&/[a-zA-Z]/.test(s)?(a=!0,s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()):s.toLowerCase()).join("")}function L(e){return e.split(",").map(t=>`<span class="page-segment">${t.trim()}</span>`).join(", ")}function F(e){return e?e.split(",").map(t=>t.trim()).sort((t,n)=>{let o=I(t),r=I(n);return o-r}).join(", "):""}function C(e){return e?D(e).replace(/<[^>]*>/g,"").trim():""}function I(e){let n=D(String(e||"")).match(/\d+/g);if(!n)return Number.MAX_SAFE_INTEGER;let o=n.map(r=>parseInt(r,10));return Math.min(...o)}function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function D(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function G(e){let t=e[0]||"",n=e[1]||"";return t.includes("|")&&n.match(/^(\|?[\s-]+\|?)+$/)}function Z(e){let t=["term","sub-term","notes","book","page"],n=e.split(",").map(o=>o.trim().toLowerCase());return t.every(o=>n.includes(o))}function Q(e){let t=N(e,!0),{rows:n,meta:o}=t;typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(n)));let r=M(e,{format:"csv",hasHeaders:!0});return typeof document<"u"&&(currentRenderedData=[],S=!1,document.getElementById("index_input").value=X(n),currentRenderedData=S?k(r):r,f=!0,E(currentRenderedData,f),typeof A=="function"&&A(o||{})),r}function X(e){let t=["term","sub-term","notes","book","page"],n=[t];for(let o of e){let r=t.map(a=>Y(o[a]||""));n.push(r)}return n.map(o=>o.join(",")).join(`
`)}function Y(e){let t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function A(e={}){if(document.getElementById("meta_title").value=e.title||"",document.getElementById("meta_css").value=e.customCSS||"",z(e.customCSS),T(),e.fontSize&&!isNaN(e.fontSize)){let t=document.getElementById("print_font_size");if(t){t.value=e.fontSize;let n=document.querySelector("#output table");n&&(n.style.fontSize=`${e.fontSize}px`)}}if(typeof e.collapsed=="boolean"){f=e.collapsed;let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields")}if(e.hasDividers&&Array.isArray(currentRenderedData)){currentRenderedData=k(currentRenderedData),S=!0;let t=document.getElementById("insert_dividers_button");t&&(t.textContent="Remove Letter Dividers")}else S=!1;Array.isArray(currentRenderedData)&&E(currentRenderedData,f)}function ee(){document.getElementById("save_to_csv_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block"}function te(){let e=document.getElementById("insert_dividers_button");e&&(e.textContent=S?"Remove Letter Dividers":"Insert Letter Dividers");let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand Duplicate Fields":"Collapse Duplicate Fields");let n=document.getElementById("print_font_size"),o=document.querySelector("#output table");n&&o&&(o.style.fontSize=`${B()}px`)}function k(e){if(!Array.isArray(e))return e;let t=[],n=null;for(let o of e){if(o._ignore||o.divider){t.push(o);continue}let r=D(o.term).charAt(0).toUpperCase();r!==n&&(t.push({divider:r}),n=r),t.push(o)}return t}function B(){let e=document.getElementById("print_font_size"),t=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(t)?10:t))}function T(){let e=B(),t=document.getElementById("meta_css")?.value?.trim()||"",n=`table {font-size: ${e}px;}
${t}`,o=document.getElementById("print_button");o&&o.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: \`${n}\`})`)}function ne(){function e(i){let c=["Term","Sub-term","Notes","Book","Page"],u=(typeof globalThis<"u"&&globalThis.originalParsedRows||[]).filter(h=>!h._ignore).map(h=>[h.term||"",h["sub-term"]||"",h.notes||"",h.book||"",h.page||""]),d=t(),m=[`?meta: ${JSON.stringify(d)}`],g=[c,m,...u].map(h=>h.map(P=>`"${String(P).replace(/"/g,'""')}"`).join(",")).join(`
`),v=new Blob([g],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(v),p=document.createElement("a");p.href=w;let y=(d.title||"index").replace(/[^\w-]+/g,"_");p.download=`${y}.csv`,p.style.display="none",document.body.appendChild(p),p.click(),document.body.removeChild(p)}function t(){return{title:document.getElementById("meta_title")?.value?.trim()||null,customCSS:document.getElementById("meta_css")?.value?.trim()||null,fontSize:parseInt(document.getElementById("print_font_size")?.value,10)||null,collapsed:!!f,hasDividers:currentRenderedData?.some(i=>i.divider)||!1}}function n(){let i=document.getElementById("import_csv_file");i&&i.addEventListener("change",c=>{let l=c.target.files?.[0];if(!l)return;let u=new FileReader;u.onload=()=>{let d=u.result;Q(d),i.value=""},u.readAsText(l)})}n();let o=document.getElementById("import_csv_button"),r=document.getElementById("import_csv_file");o&&r&&o.addEventListener("click",()=>{r.click()});let a=document.getElementById("insert_dividers_button");a?.addEventListener("click",()=>{S=!currentRenderedData.some(c=>c.divider),S?(currentRenderedData=k(currentRenderedData),a.textContent="Remove Letter Dividers"):(currentRenderedData=currentRenderedData.filter(c=>!c.divider),a.textContent="Insert Letter Dividers"),E(currentRenderedData,f)}),document.getElementById("save_to_csv_button").onclick=()=>e(currentRenderedData,f),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{f=!f,document.getElementById("toggle_collapse_button").textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields",E(currentRenderedData,f)});function s(){let i=document.getElementById("print_font_size"),c=document.getElementById("increase_font"),l=document.getElementById("decrease_font"),u=document.getElementById("print_button");function d(m){let b=Math.max(1,Math.min(200,parseInt(m,10)||10));i.value=b;let g=document.querySelector("#output table");g&&(g.style.fontSize=`${b}px`),T()}i.addEventListener("input",()=>d(i.value)),c.addEventListener("click",()=>d(+i.value+1)),l.addEventListener("click",()=>d(+i.value-1)),d(i.value)}s(),window.addEventListener("keydown",i=>{let c=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((c&&i.metaKey||!c&&i.ctrlKey)&&i.key.toLowerCase()==="p"){i.preventDefault();let d=`table {font-size: ${B()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:d})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let i=document.getElementById("index_input").value,c=M(i);currentRenderedData=S?k(c):c,z(t().customCSS),T(),E(currentRenderedData,f)})}function x(e){let t=[],n="",o=!1,r=0;for(;r<e.length;){let a=e[r];o?a==='"'?e[r+1]==='"'?(n+='"',r+=2):(o=!1,r++):(n+=a,r++):a==='"'?(o=!0,r++):a===","?(t.push(n.trim()),n="",r++):(n+=a,r++)}return t.push(n.trim()),t}function N(e,t=!0){let n=e.trim().split(`
`).map(i=>i.trim());if(n.length<1)return{rows:[],meta:null};let o,r,a=null;if(t?(o=x(n[0]).map(i=>i.trim().toLowerCase()),r=n.slice(1)):(o=["term","sub-term","notes","book","page"],r=n),r.length>0){let i=r[0],c=x(i)[0];if(c&&c.startsWith("?meta:")){try{let l=c.replace(/^\?meta:\s*/,"");a=JSON.parse(l)}catch{}r.shift()}}return{rows:r.map(i=>{let c=x(i),l={};return o.forEach((d,m)=>{l[d]=c[m]||""}),(l.term?.trim()||"").startsWith("?")&&(l._ignore=!0),l}),meta:a}}function M(e,t={}){let n=e.trim(),o=n.split(`
`),r=t.format||(n.includes(",")&&!n.includes("|")?"csv":"markdown"),a="hasHeaders"in t?t.hasHeaders:r==="markdown"?G(o):Z(o[0]),s;if(r==="markdown")s=j(n,a);else if(r==="csv"){let u=N(n,a);s=u.rows,meta=u.meta}typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(s)));let i=O(s);J(s),U(s,i),q(s);let c=H(s),l=V(c);return K(l)}typeof document<"u"&&ne();
