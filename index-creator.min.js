function B(o){let s=o.trim().split(`
`).map(n=>n.trim());if(s.length<2)return[];let r=s[0].replace(/^\||\|$/g,"").split("|").map(n=>n.trim()),e=s.slice(2).map(n=>{let t=n.replace(/^\||\|$/g,"").split("|").map(i=>i.trim()),c={};return r.forEach((i,a)=>{c[i]=t[a]||""}),c});return e.forEach(n=>{(n.term?.trim()||"").startsWith("?")&&(n._ignore=!0)}),e}function D(o){let s={},r=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let l of o)for(let e of["term","sub-term","notes"]){let n=l[e]||"",t;for(;(t=r.exec(n))!==null;){let c=(t[1]||t[2]||t[3]||"").toLowerCase().trim(),i="";t[5]?i=t[5].trim():t[6]?i=t[6].trim():t[7]&&(i=t[7].trim()),c&&i&&(s[c]=i)}}return s}function L(o){let s=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let r of o)for(let l of["term","sub-term","notes"])r[l]&&(r[l]=r[l].replace(s,(e,n,t,c)=>n||t||c||""))}function F(o,s){for(let r of o)["term","sub-term","notes"].forEach(l=>{let e=r[l]||"",n={};for(let t of Object.keys(s)){let c=new RegExp(`\\!\\b${C(t)}\\b`,"gi");e=e.replace(c,i=>{let a=`temp_placeholder_${t.toUpperCase()}`;return n[a]=i.slice(1),a})}for(let[t,c]of Object.entries(s)){let i=new RegExp(`\\b${C(t)}\\b`,"gi");e=e.replace(i,a=>P(a,c))}for(let[t,c]of Object.entries(n)){let i=new RegExp(C(t),"g");e=e.replace(i,c)}r[l]=e})}function A(o){let s=[];for(let r of o){let l=(r.term||"").trim(),e=(r["sub-term"]||"").trim();if(!(l.includes("<>")||e.includes("<>"))){s.push(r);continue}let t=l.replace(/<>/g,"").trim(),c=e.replace(/<>/g,"").trim();s.push({...r,term:t,"sub-term":c,_ignore:r._ignore||!1}),s.push({...r,term:c,"sub-term":t,_ignore:r._ignore||!1})}return s}function M(o){let s=[];for(let r of o){let e=["term","sub-term","notes","book","page"].map(m=>{let p=r[m]||"";return p.includes("&&")?p.split("&&").map(d=>d.trim()):[p.trim()]}),[n,t,c,i,a]=e;for(let m of n)for(let p of t)for(let d of c)for(let g of i)for(let u of a)s.push({term:m,"sub-term":p,notes:d,book:g,page:u,_ignore:r._ignore||!1})}return s}function j(o){let s={};o.forEach((r,l)=>{if(!r._ignore){for(let e of["term","sub-term","notes","book","page"]){let n=(r[e]||"").trim();(e==="term"&&n===""||n==="^^")&&(r[e]=s[e]||"")}s={...r}}})}function N(o){let s=[],r={term:"",subTerm:"",notes:"",book:0,page:""};for(let l of o){if(l._ignore)continue;let e=(l.term||"").trim(),n=(l["sub-term"]||"").trim(),t=(l.notes||"").trim(),c=(l.book||"").trim(),i=(l.page||"").trim(),a=e!=="",m=n!=="",p=t!=="",d=c!=="",g=i!=="",u=e,b=n,_=t,y=d?parseInt(c):0,w=g?S(i):r.page;a&&!m&&!p&&!d&&!g?(u=e,b="",_="",y=r.book,w=r.page):!a&&m&&!p&&!d&&!g?(u=r.term,b=n,_="",y=r.book,w=r.page):(u=e,b=n,_=t,y=d?parseInt(c):r.book,w=g?S(i):r.page);let $={term:u,subTerm:b,notes:_,book:y,page:w};s.push($),r=$}return s.sort((l,e)=>{let n=E(l.term).localeCompare(E(e.term));if(n!==0)return n;let t=E(l.subTerm).localeCompare(E(e.subTerm));if(t!==0)return t;let c=x(l.page),i=x(e.page);return c-i}),s}function k(o,s){document.getElementById("export_csv_button").onclick=()=>I(o),document.getElementById("export_excel_button").onclick=()=>R(o);let r=document.createElement("table"),l=[];if(s){let e=0;for(;e<o.length;){let n=o[e];if(n.divider){l.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${n.divider}</strong></td>
    </tr>
  `),e++;continue}let t=o.slice(e).filter(i=>i.term===n.term),c=t.length;for(let i=0;i<c;){let a=o[e+i],p=t.slice(i).filter(u=>u.subTerm===a.subTerm).length,d=i===0?`<td rowspan="${c}">${f(a.term)}</td>`:"",g=p>1?`<td rowspan="${p}">${f(a.subTerm)}</td>`:`<td>${f(a.subTerm)}</td>`;l.push(`
          <tr>
            ${d}
            ${g}
            <td>${f(a.notes)}</td>
            <td>${a.book}</td>
            <td>${v(f(a.page))}</td>


          </tr>
        `);for(let u=1;u<p;u++){let b=o[e+i+u];l.push(`
            <tr>
              <td>${f(b.notes)}</td>
              <td>${b.book}</td>
              <td>${b.page}</td>
            </tr>
          `)}i+=p}e+=c}}else o.forEach(e=>{if(e.divider){l.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${e.divider}</strong></td>
      </tr>
    `);return}l.push(`
        <tr>
          <td>${f(e.term)}</td>
          <td>${f(e.subTerm)}</td>
          <td>${f(e.notes)}</td>
          <td>${e.book}</td>
          <td>${v(f(e.page))}</td>


        </tr>
      `)});r.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${l.join("")}
    </tbody>
  `,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(r)}function P(o,s){let r=o===o.toUpperCase(),l=o[0]===o[0].toUpperCase(),e=s.split(/\b/),n=!1;return e.map(t=>/[A-Z]{2,}/.test(t)?t:r?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():l&&!n&&/[a-zA-Z]/.test(t)?(n=!0,t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()):t.toLowerCase()).join("")}function v(o){return o.split(",").map(s=>`<span class="page-segment">${s.trim()}</span>`).join(", ")}function S(o){return o?o.split(",").map(s=>s.trim()).sort((s,r)=>{let l=x(s),e=x(r);return l-e}).join(", "):""}function E(o){return o?o.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function x(o){let r=h(String(o||"")).match(/\d+/g);if(!r)return Number.MAX_SAFE_INTEGER;let l=r.map(e=>parseInt(e,10));return Math.min(...l)}function C(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(o){if(!o)return"";let s={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return o=o.replace(/\\`/g,s.backtick).replace(/\\\*/g,s.star),o=o.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),o=o.replace(new RegExp(s.backtick,"g"),"`").replace(new RegExp(s.star,"g"),"*"),o}function h(o){if(!o)return"";let s={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return o=o.replace(/\\`/g,s.backtick).replace(/\\\*/g,s.star),o=o.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),o=o.replace(new RegExp(s.backtick,"g"),"`").replace(new RegExp(s.star,"g"),"*"),o}function z(){let o=document.getElementById("insert_dividers_button");o?.addEventListener("click",()=>{currentRenderedData.some(n=>n.divider)?(currentRenderedData=currentRenderedData.filter(n=>!n.divider),o.textContent="Insert Letter Dividers"):(currentRenderedData=s(currentRenderedData),o.textContent="Remove Letter Dividers"),k(currentRenderedData,isCollapsed)});function s(e){if(!Array.isArray(e))return e;let n=[],t=null;for(let c of e){if(c._ignore||c.divider){n.push(c);continue}let i=h(c.term).charAt(0).toUpperCase();i!==t&&(n.push({divider:i}),t=i),n.push(c)}return n}function r(){let e=document.getElementById("print_font_size"),n=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(n)?10:n))}document.getElementById("export_csv_button").onclick=()=>I(currentRenderedData),document.getElementById("export_excel_button").onclick=()=>R(currentRenderedData),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{isCollapsed=!isCollapsed,document.getElementById("toggle_collapse_button").textContent=isCollapsed?"Expand duplicate fields":"Collapse Duplicate Fields",k(currentRenderedData,isCollapsed)});function l(){let e=document.getElementById("print_font_size"),n=document.getElementById("increase_font"),t=document.getElementById("decrease_font"),c=document.getElementById("print_button");function i(a){let m=Math.max(1,Math.min(200,parseInt(a,10)||10));e.value=m;let p=`table {font-size: ${m}px;}`;c.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: '${p}'})`);let d=document.querySelector("#output table");d&&(d.style.fontSize=`${m}px`)}e.addEventListener("input",()=>i(e.value)),n.addEventListener("click",()=>i(+e.value+1)),t.addEventListener("click",()=>i(+e.value-1)),i(e.value)}l(),window.addEventListener("keydown",e=>{let n=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((n&&e.metaKey||!n&&e.ctrlKey)&&e.key.toLowerCase()==="p"){e.preventDefault();let i=`table {font-size: ${r()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:i})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("export_csv_button").style.display="inline-block",document.getElementById("export_excel_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block",document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let e=document.getElementById("index_input").value,n=B(e),t=D(n);L(n),F(n,t),j(n);let c=A(n),i=M(c),a=N(i);currentRenderedData=a,isCollapsed=!0,k(currentRenderedData,isCollapsed)})}function T(o,s){let r=o.filter(t=>!t.divider),l=[],e=null,n=null;for(let t of r){let c=t.term===e?"":t.term,i=t.term===e&&t.subTerm===n?"":t.subTerm;l.push({term:c,subTerm:i,notes:t.notes,book:t.book,page:t.page}),e=t.term,n=t.subTerm}return l}function I(o){let s=T(o,isCollapsed),l=[["Term","Sub-term","Notes","Book","Page"],...s.map(c=>[h(c.term),h(c.subTerm),h(c.notes),c.book,c.page])].map(c=>c.map(i=>`"${String(i).replace(/"/g,'""')}"`).join(",")).join(`
`),e=new Blob([l],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download="index.csv",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function R(o){let s=T(o,isCollapsed),r=[["Term","Sub-term","Notes","Book","Page"],...s.map(n=>[h(n.term),h(n.subTerm),h(n.notes),n.book,n.page])],l=XLSX.utils.aoa_to_sheet(r),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,l,"Index"),XLSX.writeFile(e,"index.xlsx")}typeof document<"u"&&z();
