function B(n){let r=n.trim().split(`
`).map(o=>o.trim());if(r.length<2)return[];let s=r[0].replace(/^\||\|$/g,"").split("|").map(o=>o.trim()),e=r.slice(2).map(o=>{let t=o.replace(/^\||\|$/g,"").split("|").map(i=>i.trim()),c={};return s.forEach((i,a)=>{c[i]=t[a]||""}),c});return e.forEach(o=>{(o.term?.trim()||"").startsWith("?")&&(o._ignore=!0)}),e}function D(n){let r={},s=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let l of n)for(let e of["term","sub-term","notes"]){let o=l[e]||"",t;for(;(t=s.exec(o))!==null;){let c=(t[1]||t[2]||t[3]||"").toLowerCase().trim(),i="";t[5]?i=t[5].trim():t[6]?i=t[6].trim():t[7]&&(i=t[7].trim()),c&&i&&(r[c]=i)}}return r}function L(n){let r=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let s of n)for(let l of["term","sub-term","notes"])s[l]&&(s[l]=s[l].replace(r,(e,o,t,c)=>o||t||c||""))}function F(n,r){for(let s of n)["term","sub-term","notes"].forEach(l=>{let e=s[l]||"",o={};for(let t of Object.keys(r)){let c=new RegExp(`\\!\\b${C(t)}\\b`,"gi");e=e.replace(c,i=>{let a=`temp_placeholder_${t.toUpperCase()}`;return o[a]=i.slice(1),a})}for(let[t,c]of Object.entries(r)){let i=new RegExp(`\\b${C(t)}\\b`,"gi");e=e.replace(i,a=>N(a,c))}for(let[t,c]of Object.entries(o)){let i=new RegExp(C(t),"g");e=e.replace(i,c)}s[l]=e})}function A(n){let r=[];for(let s of n){let l=(s.term||"").trim(),e=(s["sub-term"]||"").trim();if(!(l.includes("<>")||e.includes("<>"))){r.push(s);continue}let t=l.replace(/<>/g,"").trim(),c=e.replace(/<>/g,"").trim();r.push({...s,term:t,"sub-term":c,_ignore:s._ignore||!1}),r.push({...s,term:c,"sub-term":t,_ignore:s._ignore||!1})}return r}function M(n){let r=[];for(let s of n){let e=["term","sub-term","notes","book","page"].map(m=>{let p=s[m]||"";return p.includes("&&")?p.split("&&").map(d=>d.trim()):[p.trim()]}),[o,t,c,i,a]=e;for(let m of o)for(let p of t)for(let d of c)for(let g of i)for(let u of a)r.push({term:m,"sub-term":p,notes:d,book:g,page:u,_ignore:s._ignore||!1})}return r}function j(n){let r={};n.forEach((s,l)=>{if(!s._ignore){for(let e of["term","sub-term","notes","book","page"])(s[e]||"").trim()==="^^"&&(s[e]=r[e]||"");r={...s}}})}function z(n){let r=[],s={term:"",subTerm:"",notes:"",book:0,page:""};for(let l of n){if(l._ignore)continue;let e=(l.term||"").trim(),o=(l["sub-term"]||"").trim(),t=(l.notes||"").trim(),c=(l.book||"").trim(),i=(l.page||"").trim(),a=e!=="",m=o!=="",p=t!=="",d=c!=="",g=i!=="",u=e,b=o,_=t,y=d?parseInt(c):0,w=g?v(i):s.page;a&&!m&&!p&&!d&&!g?(u=e,b="",_="",y=s.book,w=s.page):!a&&m&&!p&&!d&&!g?(u=s.term,b=o,_="",y=s.book,w=s.page):(u=e||s.term,b=o,_=t,y=d?parseInt(c):s.book,w=g?v(i):s.page);let $={term:u,subTerm:b,notes:_,book:y,page:w};r.push($),s=$}return r.sort((l,e)=>{let o=E(l.term).localeCompare(E(e.term));if(o!==0)return o;let t=E(l.subTerm).localeCompare(E(e.subTerm));if(t!==0)return t;let c=x(l.page),i=x(e.page);return c-i}),r}function k(n,r){document.getElementById("export_csv_button").onclick=()=>I(n),document.getElementById("export_excel_button").onclick=()=>R(n);let s=document.createElement("table"),l=[];if(r){let e=0;for(;e<n.length;){let o=n[e];if(o.divider){l.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${o.divider}</strong></td>
    </tr>
  `),e++;continue}let t=n.slice(e).filter(i=>i.term===o.term),c=t.length;for(let i=0;i<c;){let a=n[e+i],p=t.slice(i).filter(u=>u.subTerm===a.subTerm).length,d=i===0?`<td rowspan="${c}">${f(a.term)}</td>`:"",g=p>1?`<td rowspan="${p}">${f(a.subTerm)}</td>`:`<td>${f(a.subTerm)}</td>`;l.push(`
          <tr>
            ${d}
            ${g}
            <td>${f(a.notes)}</td>
            <td>${a.book}</td>
            <td>${S(f(a.page))}</td>


          </tr>
        `);for(let u=1;u<p;u++){let b=n[e+i+u];l.push(`
            <tr>
              <td>${f(b.notes)}</td>
              <td>${b.book}</td>
              <td>${b.page}</td>
            </tr>
          `)}i+=p}e+=c}}else n.forEach(e=>{if(e.divider){l.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${e.divider}</strong></td>
      </tr>
    `);return}l.push(`
        <tr>
          <td>${f(e.term)}</td>
          <td>${f(e.subTerm)}</td>
          <td>${f(e.notes)}</td>
          <td>${e.book}</td>
          <td>${S(f(e.page))}</td>


        </tr>
      `)});s.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${l.join("")}
    </tbody>
  `,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(s),s.style.fontSize=`${getCurrentFontSize()}px`}function N(n,r){let s=n===n.toUpperCase(),l=n[0]===n[0].toUpperCase(),e=r.split(/\b/),o=!1;return e.map(t=>/[A-Z]{2,}/.test(t)?t:s?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():l&&!o&&/[a-zA-Z]/.test(t)?(o=!0,t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()):t.toLowerCase()).join("")}function S(n){return n.split(",").map(r=>`<span class="page-segment">${r.trim()}</span>`).join(", ")}function v(n){return n?n.split(",").map(r=>r.trim()).sort((r,s)=>{let l=x(r),e=x(s);return l-e}).join(", "):""}function E(n){return n?n.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function x(n){let s=h(String(n||"")).match(/\d+/g);if(!s)return Number.MAX_SAFE_INTEGER;let l=s.map(e=>parseInt(e,10));return Math.min(...l)}function C(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(n){if(!n)return"";let r={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return n=n.replace(/\\`/g,r.backtick).replace(/\\\*/g,r.star),n=n.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),n=n.replace(new RegExp(r.backtick,"g"),"`").replace(new RegExp(r.star,"g"),"*"),n}function h(n){if(!n)return"";let r={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return n=n.replace(/\\`/g,r.backtick).replace(/\\\*/g,r.star),n=n.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),n=n.replace(new RegExp(r.backtick,"g"),"`").replace(new RegExp(r.star,"g"),"*"),n}function P(){let n=document.getElementById("insert_dividers_button");n?.addEventListener("click",()=>{currentRenderedData.some(o=>o.divider)?(currentRenderedData=currentRenderedData.filter(o=>!o.divider),n.textContent="Insert Letter Dividers"):(currentRenderedData=r(currentRenderedData),n.textContent="Remove Letter Dividers"),k(currentRenderedData,isCollapsed)});function r(e){if(!Array.isArray(e))return e;let o=[],t=null;for(let c of e){if(c._ignore||c.divider){o.push(c);continue}let i=h(c.term).charAt(0).toUpperCase();i!==t&&(o.push({divider:i}),t=i),o.push(c)}return o}function s(){let e=document.getElementById("print_font_size"),o=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(o)?10:o))}document.getElementById("export_csv_button").onclick=()=>I(currentRenderedData),document.getElementById("export_excel_button").onclick=()=>R(currentRenderedData),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{isCollapsed=!isCollapsed,document.getElementById("toggle_collapse_button").textContent=isCollapsed?"Expand duplicate fields":"Collapse Duplicate Fields",k(currentRenderedData,isCollapsed)});function l(){let e=document.getElementById("print_font_size"),o=document.getElementById("increase_font"),t=document.getElementById("decrease_font"),c=document.getElementById("print_button");function i(a){let m=Math.max(1,Math.min(200,parseInt(a,10)||10));e.value=m;let p=`table {font-size: ${m}px;}`;c.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: '${p}'})`);let d=document.querySelector("#output table");d&&(d.style.fontSize=`${m}px`)}e.addEventListener("input",()=>i(e.value)),o.addEventListener("click",()=>i(+e.value+1)),t.addEventListener("click",()=>i(+e.value-1)),i(e.value)}l(),window.addEventListener("keydown",e=>{let o=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((o&&e.metaKey||!o&&e.ctrlKey)&&e.key.toLowerCase()==="p"){e.preventDefault();let i=`table {font-size: ${s()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:i})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("export_csv_button").style.display="inline-block",document.getElementById("export_excel_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block",document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let e=document.getElementById("index_input").value,o=B(e),t=D(o);L(o),F(o,t),j(o);let c=A(o),i=M(c),a=z(i);currentRenderedData=a,isCollapsed=!0,k(currentRenderedData,isCollapsed)})}function T(n,r){let s=n.filter(t=>!t.divider),l=[],e=null,o=null;for(let t of s){let c=t.term===e?"":t.term,i=t.term===e&&t.subTerm===o?"":t.subTerm;l.push({term:c,subTerm:i,notes:t.notes,book:t.book,page:t.page}),e=t.term,o=t.subTerm}return l}function I(n){let r=T(n,isCollapsed),l=[["Term","Sub-term","Notes","Book","Page"],...r.map(c=>[h(c.term),h(c.subTerm),h(c.notes),c.book,c.page])].map(c=>c.map(i=>`"${String(i).replace(/"/g,'""')}"`).join(",")).join(`
`),e=new Blob([l],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download="index.csv",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function R(n){let r=T(n,isCollapsed),s=[["Term","Sub-term","Notes","Book","Page"],...r.map(o=>[h(o.term),h(o.subTerm),h(o.notes),o.book,o.page])],l=XLSX.utils.aoa_to_sheet(s),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,l,"Index"),XLSX.writeFile(e,"index.xlsx")}typeof document<"u"&&P();
