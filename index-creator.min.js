function L(e){let o=e.trim().split(`
`).map(r=>r.trim());if(o.length<2)return[];let n=o[0].replace(/^\||\|$/g,"").split("|").map(r=>r.trim()),t=o.slice(2).map(r=>{let s=r.replace(/^\||\|$/g,"").split("|").map(a=>a.trim()),l={};return n.forEach((a,i)=>{l[a]=s[i]||""}),l});return t.forEach(r=>{(r.term?.trim()||"").startsWith("?")&&(r._ignore=!0)}),t}function v(e){let o={},n=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let c of e)for(let t of["term","sub-term","notes"]){let r=c[t]||"",s;for(;(s=n.exec(r))!==null;){let l=(s[1]||s[2]||s[3]||"").toLowerCase().trim(),a="";s[5]?a=s[5].trim():s[6]?a=s[6].trim():s[7]&&(a=s[7].trim()),l&&a&&(o[l]=a)}}return o}function F(e){let o=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let n of e)for(let c of["term","sub-term","notes"])n[c]&&(n[c]=n[c].replace(o,(t,r,s,l)=>r||s||l||""))}function j(e,o){for(let n of e)["term","sub-term","notes"].forEach(c=>{let t=n[c]||"",r={};for(let s of Object.keys(o)){let l=new RegExp(`\\!\\b${T(s)}\\b`,"gi");t=t.replace(l,a=>{let i=`temp_placeholder_${s.toUpperCase()}`;return r[i]=a.slice(1),i})}for(let[s,l]of Object.entries(o)){let a=new RegExp(`\\b${T(s)}\\b`,"gi");t=t.replace(a,i=>M(i,l))}for(let[s,l]of Object.entries(r)){let a=new RegExp(T(s),"g");t=t.replace(a,l)}n[c]=t})}function D(e){let o=[];for(let n of e){let c=(n.term||"").trim(),t=(n["sub-term"]||"").trim();if(!(c.includes("<>")||t.includes("<>"))){o.push(n);continue}let s=c.replace(/<>/g,"").trim(),l=t.replace(/<>/g,"").trim();o.push({...n,term:s,"sub-term":l,_ignore:n._ignore||!1}),o.push({...n,term:l,"sub-term":s,_ignore:n._ignore||!1})}return o}function A(e){let o=[];for(let n of e){let t=["term","sub-term","notes","book","page"].map(b=>{let p=n[b]||"";return p.includes("&&")?p.split("&&").map(d=>d.trim()):[p.trim()]}),[r,s,l,a,i]=t;for(let b of r)for(let p of s)for(let d of l)for(let g of a)for(let u of i)o.push({term:b,"sub-term":p,notes:d,book:g,page:u,_ignore:n._ignore||!1})}return o}function N(e){let o={};e.forEach((n,c)=>{if(!n._ignore){for(let t of["term","sub-term","notes","book","page"])(n[t]||"").trim()==="^^"&&(n[t]=o[t]||"");o={...n}}})}function P(e){let o=[],n={term:"",subTerm:"",notes:"",book:0,page:""};for(let c of e){if(c._ignore)continue;let t=(c.term||"").trim(),r=(c["sub-term"]||"").trim(),s=(c.notes||"").trim(),l=(c.book||"").trim(),a=(c.page||"").trim(),i=t!=="",b=r!=="",p=s!=="",d=l!=="",g=a!=="",u=t,f=r,_=s,w=d?parseInt(l):0,$=g?S(a):n.page;i&&!b&&!p&&!d&&!g?(u=t,f="",_="",w=n.book,$=n.page):!i&&b&&!p&&!d&&!g?(u=n.term,f=r,_="",w=n.book,$=n.page):(u=t||n.term,f=r,_=s,w=d?parseInt(l):n.book,$=g?S(a):n.page);let C={term:u,subTerm:f,notes:_,book:w,page:$};o.push(C),n=C}return o.sort((c,t)=>{let r=k(c.term).localeCompare(k(t.term));if(r!==0)return r;let s=k(c.subTerm).localeCompare(k(t.subTerm));if(s!==0)return s;let l=x(c.page),a=x(t.page);return l-a}),o}function E(e,o){document.getElementById("export_csv_button").onclick=()=>I(e),document.getElementById("export_excel_button").onclick=()=>B(e);let n=document.createElement("table"),c=[];if(o){let t=0;for(;t<e.length;){let r=e[t],s=e.slice(t).filter(a=>a.term===r.term),l=s.length;for(let a=0;a<l;){let i=e[t+a],p=s.slice(a).filter(u=>u.subTerm===i.subTerm).length,d=a===0?`<td rowspan="${l}">${m(i.term)}</td>`:"",g=p>1?`<td rowspan="${p}">${m(i.subTerm)}</td>`:`<td>${m(i.subTerm)}</td>`;c.push(`
          <tr>
            ${d}
            ${g}
            <td>${m(i.notes)}</td>
            <td>${i.book}</td>
            <td>${y(m(i.page))}</td>


          </tr>
        `);for(let u=1;u<p;u++){let f=e[t+a+u];c.push(`
            <tr>
              <td>${m(f.notes)}</td>
              <td>${f.book}</td>
              <td>${f.page}</td>
            </tr>
          `)}a+=p}t+=l}}else e.forEach(t=>{c.push(`
        <tr>
          <td>${m(t.term)}</td>
          <td>${m(t.subTerm)}</td>
          <td>${m(t.notes)}</td>
          <td>${t.book}</td>
          <td>${y(m(t.page))}</td>


        </tr>
      `)});n.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${c.join("")}
    </tbody>
  `,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(n)}function M(e,o){let n=e===e.toUpperCase(),c=e[0]===e[0].toUpperCase(),t=o.split(/\b/),r=!1;return t.map(s=>/[A-Z]{2,}/.test(s)?s:n?s.charAt(0).toUpperCase()+s.slice(1).toLowerCase():c&&!r&&/[a-zA-Z]/.test(s)?(r=!0,s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()):s.toLowerCase()).join("")}function y(e){return e.split(",").map(o=>`<span class="page-segment">${o.trim()}</span>`).join(", ")}function S(e){return e?e.split(",").map(o=>o.trim()).sort((o,n)=>{let c=x(o),t=x(n);return c-t}).join(", "):""}function k(e){return e?e.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function x(e){let n=h(String(e||"")).match(/\d+/g);if(!n)return Number.MAX_SAFE_INTEGER;let c=n.map(t=>parseInt(t,10));return Math.min(...c)}function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function m(e){if(!e)return"";let o={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,o.backtick).replace(/\\\*/g,o.star),e=e.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),e=e.replace(new RegExp(o.backtick,"g"),"`").replace(new RegExp(o.star,"g"),"*"),e}function h(e){if(!e)return"";let o={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,o.backtick).replace(/\\\*/g,o.star),e=e.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),e=e.replace(new RegExp(o.backtick,"g"),"`").replace(new RegExp(o.star,"g"),"*"),e}function U(){document.getElementById("export_csv_button").onclick=()=>I(currentRenderedData),document.getElementById("export_excel_button").onclick=()=>B(currentRenderedData),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{isCollapsed=!isCollapsed,document.getElementById("toggle_collapse_button").textContent=isCollapsed?"Expand duplicate fields":"Collapse duplicate fields",E(currentRenderedData,isCollapsed)}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("export_csv_button").style.display="inline-block",document.getElementById("export_excel_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block";let e=document.getElementById("index_input").value,o=L(e),n=v(o);F(o),j(o,n),N(o);let c=D(o),t=A(c),r=P(t);currentRenderedData=r,isCollapsed=!0,E(currentRenderedData,isCollapsed)})}function R(e,o){if(!o)return e;let n=[],c=null,t=null;for(let r of e){let s=r.term===c?"":r.term,l=r.term===c&&r.subTerm===t?"":r.subTerm;n.push({term:s,subTerm:l,notes:r.notes,book:r.book,page:r.page}),c=r.term,t=r.subTerm}return n}function I(e){let o=R(e,isCollapsed),c=[["Term","Sub-term","Notes","Book","Page"],...o.map(l=>[h(l.term),h(l.subTerm),h(l.notes),l.book,l.page])].map(l=>l.map(a=>`"${String(a).replace(/"/g,'""')}"`).join(",")).join(`
`),t=new Blob([c],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(t),s=document.createElement("a");s.href=r,s.download="index.csv",s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function B(e){let o=R(e,isCollapsed),n=[["Term","Sub-term","Notes","Book","Page"],...o.map(r=>[h(r.term),h(r.subTerm),h(r.notes),r.book,r.page])],c=XLSX.utils.aoa_to_sheet(n),t=XLSX.utils.book_new();XLSX.utils.book_append_sheet(t,c,"Index"),XLSX.writeFile(t,"index.xlsx")}typeof document<"u"&&U();
