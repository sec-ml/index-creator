var v=!1,f=!0;function M(e,t=!0){let n=e.trim().split(`
`).map(s=>s.trim());if(n.length<1)return[];let r,o;t?(r=n[0].replace(/^\||\|$/g,"").split("|").map(s=>s.trim()),o=n.slice(2)):(r=["term","sub-term","notes","book","page"],o=n);let a=o.map(s=>{let i=s.replace(/^\||\|$/g,"").split("|").map(l=>l.trim()),c={};return r.forEach((l,u)=>{c[l]=i[u]||""}),c});return a.forEach(s=>{(s.term?.trim()||"").startsWith("?")&&(s._ignore=!0)}),a}function j(e){let t={},n=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let r of e)for(let o of["term","sub-term","notes"]){let a=r[o]||"",s;for(;(s=n.exec(a))!==null;){let i=(s[1]||s[2]||s[3]||"").toLowerCase().trim(),c="";s[5]?c=s[5].trim():s[6]?c=s[6].trim():s[7]&&(c=s[7].trim()),i&&c&&(t[i]=c)}}return t}function O(e){let t=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let n of e)for(let r of["term","sub-term","notes"])n[r]&&(n[r]=n[r].replace(t,(o,a,s,i)=>a||s||i||""))}function J(e,t){for(let n of e)["term","sub-term","notes"].forEach(r=>{let o=n[r]||"",a={};for(let s of Object.keys(t)){let i=new RegExp(`\\!\\b${R(s)}\\b`,"gi");o=o.replace(i,c=>{let l=`temp_placeholder_${s.toUpperCase()}`;return a[l]=c.slice(1),l})}for(let[s,i]of Object.entries(t)){let c=new RegExp(`\\b${R(s)}\\b`,"gi");o=o.replace(c,l=>K(l,i))}for(let[s,i]of Object.entries(a)){let c=new RegExp(R(s),"g");o=o.replace(c,i)}n[r]=o})}function U(e){let t=[];for(let n of e){let r=(n.term||"").trim(),o=(n["sub-term"]||"").trim();if(!(r.includes("<>")||o.includes("<>"))){t.push(n);continue}let s=r.replace(/<>/g,"").trim(),i=o.replace(/<>/g,"").trim();t.push({...n,term:s,"sub-term":i,_ignore:n._ignore||!1}),t.push({...n,term:i,"sub-term":s,_ignore:n._ignore||!1})}return t}function H(e){let t=[];for(let n of e){let o=["term","sub-term","notes","book","page"].map(u=>{let d=n[u]||"";return d.includes("&&")?d.split("&&").map(m=>m.trim()):[d.trim()]}),[a,s,i,c,l]=o;for(let u of a)for(let d of s)for(let m of i)for(let g of c)for(let p of l)t.push({term:u,"sub-term":d,notes:m,book:g,page:p,_ignore:n._ignore||!1})}return t}function V(e){let t={};e.forEach((n,r)=>{if(!n._ignore){for(let o of["term","sub-term","notes","book","page"]){let a=(n[o]||"").trim();(o==="term"&&a===""||a==="^^")&&(n[o]=t[o]||"")}t={...n}}})}function q(e){let t=[],n={term:"",subTerm:"",notes:"",book:0,page:""};for(let r of e){if(r._ignore)continue;let o=(r.term||"").trim(),a=(r["sub-term"]||"").trim(),s=(r.notes||"").trim(),i=(r.book||"").trim(),c=(r.page||"").trim(),l=o!=="",u=a!=="",d=s!=="",m=i!=="",g=c!=="",p=o,y=a,w=s,h=m?parseInt(i):0,S=g?D(c):n.page;l&&!u&&!d&&!m&&!g?(p=o,y="",w="",h=n.book,S=n.page):!l&&u&&!d&&!m&&!g?(p=n.term,y=a,w="",h=n.book,S=n.page):(p=o,y=a,w=s,h=m?parseInt(i):n.book,S=g?D(c):n.page);let b={term:p,subTerm:y,notes:w,book:h,page:S};t.push(b),n=b}return t.sort((r,o)=>{let a=C(r.term).localeCompare(C(o.term));if(a!==0)return a;let s=C(r.subTerm).localeCompare(C(o.subTerm));if(s!==0)return s;let i=$(r.page),c=$(o.page);return i-c}),t}function F(e){document.getElementById("custom-style").textContent=e||""}function E(e,t){let n=document.createElement("table"),r=[];if(t){let o=0;for(;o<e.length;){let a=e[o];if(a.divider){r.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${a.divider}</strong></td>
    </tr>
  `),o++;continue}let s=e.slice(o).filter(c=>c.term===a.term),i=s.length;for(let c=0;c<i;){let l=e[o+c],d=s.slice(c).filter(p=>p.subTerm===l.subTerm).length,m=c===0?`<td rowspan="${i}">${_(l.term)}</td>`:"",g=d>1?`<td rowspan="${d}">${_(l.subTerm)}</td>`:`<td>${_(l.subTerm)}</td>`;r.push(`
          <tr>
            ${m}
            ${g}
            <td>${_(l.notes)}</td>
            <td>${l.book}</td>
            <td>${T(_(l.page))}</td>


          </tr>
        `);for(let p=1;p<d;p++){let y=e[o+c+p];r.push(`
            <tr>
              <td>${_(y.notes)}</td>
              <td>${y.book}</td>
              <td>${y.page}</td>
            </tr>
          `)}c+=d}o+=i}}else e.forEach(o=>{if(o.divider){r.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${o.divider}</strong></td>
      </tr>
    `);return}r.push(`
        <tr>
          <td>${_(o.term)}</td>
          <td>${_(o.subTerm)}</td>
          <td>${_(o.notes)}</td>
          <td>${o.book}</td>
          <td>${T(_(o.page))}</td>


        </tr>
      `)});n.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${r.join("")}
    </tbody>
  `,n.style.fontSize=`${B()}px`,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(n),Y(),ee()}function K(e,t){let n=e===e.toUpperCase(),r=e[0]===e[0].toUpperCase(),o=t.split(/\b/),a=!1;return o.map(s=>/[A-Z]{2,}/.test(s)?s:n?s.charAt(0).toUpperCase()+s.slice(1).toLowerCase():r&&!a&&/[a-zA-Z]/.test(s)?(a=!0,s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()):s.toLowerCase()).join("")}function T(e){return e.split(",").map(t=>`<span class="page-segment">${t.trim()}</span>`).join(", ")}function D(e){return e?e.split(",").map(t=>t.trim()).sort((t,n)=>{let r=$(t),o=$(n);return r-o}).join(", "):""}function C(e){return e?e.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function $(e){let n=A(String(e||"")).match(/\d+/g);if(!n)return Number.MAX_SAFE_INTEGER;let r=n.map(o=>parseInt(o,10));return Math.min(...r)}function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function A(e){if(!e)return"";let t={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return e=e.replace(/\\`/g,t.backtick).replace(/\\\*/g,t.star),e=e.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),e=e.replace(new RegExp(t.backtick,"g"),"`").replace(new RegExp(t.star,"g"),"*"),e}function W(e){let t=e[0]||"",n=e[1]||"";return t.includes("|")&&n.match(/^(\|?[\s-]+\|?)+$/)}function G(e){let t=["term","sub-term","notes","book","page"],n=e.split(",").map(r=>r.trim().toLowerCase());return t.every(r=>n.includes(r))}function Z(e){let t=z(e,!0),{rows:n,meta:r}=t;typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(n)));let o=N(e,{format:"csv",hasHeaders:!0});return typeof document<"u"&&(currentRenderedData=[],v=!1,document.getElementById("index_input").value=Q(n),currentRenderedData=v?I(o):o,f=!0,E(currentRenderedData,f),typeof L=="function"&&L(r||{})),o}function Q(e){let t=["term","sub-term","notes","book","page"],n=[t];for(let r of e){let o=t.map(a=>X(r[a]||""));n.push(o)}return n.map(r=>r.join(",")).join(`
`)}function X(e){let t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function L(e={}){if(document.getElementById("meta_title").value=e.title||"",document.getElementById("meta_css").value=e.customCSS||"",F(e.customCSS),k(),e.fontSize&&!isNaN(e.fontSize)){let t=document.getElementById("print_font_size");if(t){t.value=e.fontSize;let n=document.querySelector("#output table");n&&(n.style.fontSize=`${e.fontSize}px`)}}if(typeof e.collapsed=="boolean"){f=e.collapsed;let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields")}if(e.hasDividers&&Array.isArray(currentRenderedData)){currentRenderedData=I(currentRenderedData),v=!0;let t=document.getElementById("insert_dividers_button");t&&(t.textContent="Remove Letter Dividers")}else v=!1;Array.isArray(currentRenderedData)&&E(currentRenderedData,f)}function Y(){document.getElementById("save_to_csv_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block"}function ee(){let e=document.getElementById("insert_dividers_button");e&&(e.textContent=v?"Remove Letter Dividers":"Insert Letter Dividers");let t=document.getElementById("toggle_collapse_button");t&&(t.textContent=f?"Expand Duplicate Fields":"Collapse Duplicate Fields");let n=document.getElementById("print_font_size"),r=document.querySelector("#output table");n&&r&&(r.style.fontSize=`${B()}px`)}function I(e){if(!Array.isArray(e))return e;let t=[],n=null;for(let r of e){if(r._ignore||r.divider){t.push(r);continue}let o=A(r.term).charAt(0).toUpperCase();o!==n&&(t.push({divider:o}),n=o),t.push(r)}return t}function B(){let e=document.getElementById("print_font_size"),t=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(t)?10:t))}function k(){let e=B(),t=document.getElementById("meta_css")?.value?.trim()||"",n=`table {font-size: ${e}px;}
${t}`,r=document.getElementById("print_button");r&&r.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: \`${n}\`})`)}function te(){function e(i){let c=["Term","Sub-term","Notes","Book","Page"],u=(typeof globalThis<"u"&&globalThis.originalParsedRows||[]).filter(b=>!b._ignore).map(b=>[b.term||"",b["sub-term"]||"",b.notes||"",b.book||"",b.page||""]),d=t(),m=[`?meta: ${JSON.stringify(d)}`],p=[c,m,...u].map(b=>b.map(P=>`"${String(P).replace(/"/g,'""')}"`).join(",")).join(`
`),y=new Blob([p],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(y),h=document.createElement("a");h.href=w;let S=(d.title||"index").replace(/[^\w-]+/g,"_");h.download=`${S}.csv`,h.style.display="none",document.body.appendChild(h),h.click(),document.body.removeChild(h)}function t(){return{title:document.getElementById("meta_title")?.value?.trim()||null,customCSS:document.getElementById("meta_css")?.value?.trim()||null,fontSize:parseInt(document.getElementById("print_font_size")?.value,10)||null,collapsed:!!f,hasDividers:currentRenderedData?.some(i=>i.divider)||!1}}function n(){let i=document.getElementById("import_csv_file");i&&i.addEventListener("change",c=>{let l=c.target.files?.[0];if(!l)return;let u=new FileReader;u.onload=()=>{let d=u.result;Z(d),i.value=""},u.readAsText(l)})}n();let r=document.getElementById("import_csv_button"),o=document.getElementById("import_csv_file");r&&o&&r.addEventListener("click",()=>{o.click()});let a=document.getElementById("insert_dividers_button");a?.addEventListener("click",()=>{v=!currentRenderedData.some(c=>c.divider),v?(currentRenderedData=I(currentRenderedData),a.textContent="Remove Letter Dividers"):(currentRenderedData=currentRenderedData.filter(c=>!c.divider),a.textContent="Insert Letter Dividers"),E(currentRenderedData,f)}),document.getElementById("save_to_csv_button").onclick=()=>e(currentRenderedData,f),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{f=!f,document.getElementById("toggle_collapse_button").textContent=f?"Expand duplicate fields":"Collapse Duplicate Fields",E(currentRenderedData,f)});function s(){let i=document.getElementById("print_font_size"),c=document.getElementById("increase_font"),l=document.getElementById("decrease_font"),u=document.getElementById("print_button");function d(m){let g=Math.max(1,Math.min(200,parseInt(m,10)||10));i.value=g;let p=document.querySelector("#output table");p&&(p.style.fontSize=`${g}px`),k()}i.addEventListener("input",()=>d(i.value)),c.addEventListener("click",()=>d(+i.value+1)),l.addEventListener("click",()=>d(+i.value-1)),d(i.value)}s(),window.addEventListener("keydown",i=>{let c=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((c&&i.metaKey||!c&&i.ctrlKey)&&i.key.toLowerCase()==="p"){i.preventDefault();let d=`table {font-size: ${B()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:d})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let i=document.getElementById("index_input").value,c=N(i);currentRenderedData=v?I(c):c,F(t().customCSS),k(),E(currentRenderedData,f)})}function x(e){let t=[],n="",r=!1,o=0;for(;o<e.length;){let a=e[o];r?a==='"'?e[o+1]==='"'?(n+='"',o+=2):(r=!1,o++):(n+=a,o++):a==='"'?(r=!0,o++):a===","?(t.push(n.trim()),n="",o++):(n+=a,o++)}return t.push(n.trim()),t}function z(e,t=!0){let n=e.trim().split(`
`).map(i=>i.trim());if(n.length<1)return{rows:[],meta:null};let r,o,a=null;if(t?(r=x(n[0]).map(i=>i.trim().toLowerCase()),o=n.slice(1)):(r=["term","sub-term","notes","book","page"],o=n),o.length>0){let i=o[0],c=x(i)[0];if(c&&c.startsWith("?meta:")){try{let l=c.replace(/^\?meta:\s*/,"");a=JSON.parse(l)}catch{}o.shift()}}return{rows:o.map(i=>{let c=x(i),l={};return r.forEach((d,m)=>{l[d]=c[m]||""}),(l.term?.trim()||"").startsWith("?")&&(l._ignore=!0),l}),meta:a}}function N(e,t={}){let n=e.trim(),r=n.split(`
`),o=t.format||(n.includes(",")&&!n.includes("|")?"csv":"markdown"),a="hasHeaders"in t?t.hasHeaders:o==="markdown"?W(r):G(r[0]),s;if(o==="markdown")s=M(n,a);else if(o==="csv"){let u=z(n,a);s=u.rows,meta=u.meta}typeof globalThis<"u"&&(globalThis.originalParsedRows=JSON.parse(JSON.stringify(s)));let i=j(s);O(s),J(s,i),V(s);let c=U(s),l=H(c);return q(l)}typeof document<"u"&&te();
