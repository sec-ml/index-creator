function v(t){let r=t.trim().split(`
`).map(c=>c.trim());if(r.length<2)return[];let e=r[0].replace(/^\||\|$/g,"").split("|").map(c=>c.trim()),o=r.slice(2).map(c=>{let n=c.replace(/^\||\|$/g,"").split("|").map(a=>a.trim()),l={};return e.forEach((a,i)=>{l[a]=n[i]||""}),l});return o.forEach(c=>{(c.term?.trim()||"").startsWith("?")&&(c._ignore=!0)}),o}function L(t){let r={},e=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let s of t)for(let o of["term","sub-term","notes"]){let c=s[o]||"",n;for(;(n=e.exec(c))!==null;){let l=(n[1]||n[2]||n[3]||"").toLowerCase().trim(),a="";n[5]?a=n[5].trim():n[6]?a=n[6].trim():n[7]&&(a=n[7].trim()),l&&a&&(r[l]=a)}}return r}function F(t){let r=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let e of t)for(let s of["term","sub-term","notes"])e[s]&&(e[s]=e[s].replace(r,(o,c,n,l)=>c||n||l||""))}function A(t,r){for(let e of t)["term","sub-term","notes"].forEach(s=>{let o=e[s]||"",c={};for(let n of Object.keys(r)){let l=new RegExp(`\\!\\b${E(n)}\\b`,"gi");o=o.replace(l,a=>{let i=`temp_placeholder_${n.toUpperCase()}`;return c[i]=a.slice(1),i})}for(let[n,l]of Object.entries(r)){let a=new RegExp(`\\b${E(n)}\\b`,"gi");o=o.replace(a,i=>N(i,l))}for(let[n,l]of Object.entries(c)){let a=new RegExp(E(n),"g");o=o.replace(a,l)}e[s]=o})}function D(t){let r=[];for(let e of t){let s=(e.term||"").trim(),o=(e["sub-term"]||"").trim();if(!(s.includes("<>")||o.includes("<>"))){r.push(e);continue}let n=s.replace(/<>/g,"").trim(),l=o.replace(/<>/g,"").trim();r.push({...e,term:n,"sub-term":l,_ignore:e._ignore||!1}),r.push({...e,term:l,"sub-term":n,_ignore:e._ignore||!1})}return r}function M(t){let r=[];for(let e of t){let o=["term","sub-term","notes","book","page"].map(d=>{let p=e[d]||"";return p.includes("&&")?p.split("&&").map(m=>m.trim()):[p.trim()]}),[c,n,l,a,i]=o;for(let d of c)for(let p of n)for(let m of l)for(let g of a)for(let u of i)r.push({term:d,"sub-term":p,notes:m,book:g,page:u,_ignore:e._ignore||!1})}return r}function j(t){let r={};t.forEach((e,s)=>{if(!e._ignore){for(let o of["term","sub-term","notes","book","page"])(e[o]||"").trim()==="^^"&&(e[o]=r[o]||"");r={...e}}})}function z(t){let r=[],e={term:"",subTerm:"",notes:"",book:0,page:""};for(let s of t){if(s._ignore)continue;let o=(s.term||"").trim(),c=(s["sub-term"]||"").trim(),n=(s.notes||"").trim(),l=(s.book||"").trim(),a=(s.page||"").trim(),i=o!=="",d=c!=="",p=n!=="",m=l!=="",g=a!=="",u=o,b=c,_=n,y=m?parseInt(l):0,w=g?T(a):e.page;i&&!d&&!p&&!m&&!g?(u=o,b="",_="",y=e.book,w=e.page):!i&&d&&!p&&!m&&!g?(u=e.term,b=c,_="",y=e.book,w=e.page):(u=o||e.term,b=c,_=n,y=m?parseInt(l):e.book,w=g?T(a):e.page);let $={term:u,subTerm:b,notes:_,book:y,page:w};r.push($),e=$}return r.sort((s,o)=>{let c=k(s.term).localeCompare(k(o.term));if(c!==0)return c;let n=k(s.subTerm).localeCompare(k(o.subTerm));if(n!==0)return n;let l=x(s.page),a=x(o.page);return l-a}),r}function C(t,r){document.getElementById("export_csv_button").onclick=()=>R(t),document.getElementById("export_excel_button").onclick=()=>B(t);let e=document.createElement("table"),s=[];if(r){let o=0;for(;o<t.length;){let c=t[o],n=t.slice(o).filter(a=>a.term===c.term),l=n.length;for(let a=0;a<l;){let i=t[o+a],p=n.slice(a).filter(u=>u.subTerm===i.subTerm).length,m=a===0?`<td rowspan="${l}">${f(i.term)}</td>`:"",g=p>1?`<td rowspan="${p}">${f(i.subTerm)}</td>`:`<td>${f(i.subTerm)}</td>`;s.push(`
          <tr>
            ${m}
            ${g}
            <td>${f(i.notes)}</td>
            <td>${i.book}</td>
            <td>${S(f(i.page))}</td>


          </tr>
        `);for(let u=1;u<p;u++){let b=t[o+a+u];s.push(`
            <tr>
              <td>${f(b.notes)}</td>
              <td>${b.book}</td>
              <td>${b.page}</td>
            </tr>
          `)}a+=p}o+=l}}else t.forEach(o=>{s.push(`
        <tr>
          <td>${f(o.term)}</td>
          <td>${f(o.subTerm)}</td>
          <td>${f(o.notes)}</td>
          <td>${o.book}</td>
          <td>${S(f(o.page))}</td>


        </tr>
      `)});e.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${s.join("")}
    </tbody>
  `,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(e),e.style.fontSize=`${getCurrentFontSize()}px`}function N(t,r){let e=t===t.toUpperCase(),s=t[0]===t[0].toUpperCase(),o=r.split(/\b/),c=!1;return o.map(n=>/[A-Z]{2,}/.test(n)?n:e?n.charAt(0).toUpperCase()+n.slice(1).toLowerCase():s&&!c&&/[a-zA-Z]/.test(n)?(c=!0,n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()):n.toLowerCase()).join("")}function S(t){return t.split(",").map(r=>`<span class="page-segment">${r.trim()}</span>`).join(", ")}function T(t){return t?t.split(",").map(r=>r.trim()).sort((r,e)=>{let s=x(r),o=x(e);return s-o}).join(", "):""}function k(t){return t?t.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function x(t){let e=h(String(t||"")).match(/\d+/g);if(!e)return Number.MAX_SAFE_INTEGER;let s=e.map(o=>parseInt(o,10));return Math.min(...s)}function E(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(t){if(!t)return"";let r={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return t=t.replace(/\\`/g,r.backtick).replace(/\\\*/g,r.star),t=t.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),t=t.replace(new RegExp(r.backtick,"g"),"`").replace(new RegExp(r.star,"g"),"*"),t}function h(t){if(!t)return"";let r={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return t=t.replace(/\\`/g,r.backtick).replace(/\\\*/g,r.star),t=t.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),t=t.replace(new RegExp(r.backtick,"g"),"`").replace(new RegExp(r.star,"g"),"*"),t}function P(){function t(){let e=document.getElementById("print_font_size"),s=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(s)?10:s))}document.getElementById("export_csv_button").onclick=()=>R(currentRenderedData),document.getElementById("export_excel_button").onclick=()=>B(currentRenderedData),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{isCollapsed=!isCollapsed,document.getElementById("toggle_collapse_button").textContent=isCollapsed?"Expand duplicate fields":"Collapse duplicate fields",C(currentRenderedData,isCollapsed)});function r(){let e=document.getElementById("print_font_size"),s=document.getElementById("increase_font"),o=document.getElementById("decrease_font"),c=document.getElementById("print_button");function n(l){let a=Math.max(1,Math.min(200,parseInt(l,10)||10));e.value=a;let i=`table {font-size: ${a}px;}`;c.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: '${i}'})`);let d=document.querySelector("#output table");d&&(d.style.fontSize=`${a}px`)}e.addEventListener("input",()=>n(e.value)),s.addEventListener("click",()=>n(+e.value+1)),o.addEventListener("click",()=>n(+e.value-1)),n(e.value)}r(),window.addEventListener("keydown",e=>{let s=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((s&&e.metaKey||!s&&e.ctrlKey)&&e.key.toLowerCase()==="p"){e.preventDefault();let n=`table {font-size: ${t()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:n})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("export_csv_button").style.display="inline-block",document.getElementById("export_excel_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block";let e=document.getElementById("index_input").value,s=v(e),o=L(s);F(s),A(s,o),j(s);let c=D(s),n=M(c),l=z(n);currentRenderedData=l,isCollapsed=!0,C(currentRenderedData,isCollapsed)})}function I(t,r){if(!r)return t;let e=[],s=null,o=null;for(let c of t){let n=c.term===s?"":c.term,l=c.term===s&&c.subTerm===o?"":c.subTerm;e.push({term:n,subTerm:l,notes:c.notes,book:c.book,page:c.page}),s=c.term,o=c.subTerm}return e}function R(t){let r=I(t,isCollapsed),s=[["Term","Sub-term","Notes","Book","Page"],...r.map(l=>[h(l.term),h(l.subTerm),h(l.notes),l.book,l.page])].map(l=>l.map(a=>`"${String(a).replace(/"/g,'""')}"`).join(",")).join(`
`),o=new Blob([s],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(o),n=document.createElement("a");n.href=c,n.download="index.csv",n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function B(t){let r=I(t,isCollapsed),e=[["Term","Sub-term","Notes","Book","Page"],...r.map(c=>[h(c.term),h(c.subTerm),h(c.notes),c.book,c.page])],s=XLSX.utils.aoa_to_sheet(e),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,s,"Index"),XLSX.writeFile(o,"index.xlsx")}typeof document<"u"&&P();
