function L(n,o=!0){let s=n.trim().split(`
`).map(t=>t.trim());if(s.length<1)return[];let c,e;o?(c=s[0].replace(/^\||\|$/g,"").split("|").map(t=>t.trim()),e=s.slice(2)):(c=["term","sub-term","notes","book","page"],e=s);let r=e.map(t=>{let l=t.replace(/^\||\|$/g,"").split("|").map(a=>a.trim()),i={};return c.forEach((a,p)=>{i[a]=l[p]||""}),i});return r.forEach(t=>{(t.term?.trim()||"").startsWith("?")&&(t._ignore=!0)}),r}function D(n){let o={},s=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let c of n)for(let e of["term","sub-term","notes"]){let r=c[e]||"",t;for(;(t=s.exec(r))!==null;){let l=(t[1]||t[2]||t[3]||"").toLowerCase().trim(),i="";t[5]?i=t[5].trim():t[6]?i=t[6].trim():t[7]&&(i=t[7].trim()),l&&i&&(o[l]=i)}}return o}function F(n){let o=/(?:"([^"]+)"|'([^']+)'|([\w-]+))\^("([^"]+)"|'([^']+)'|([\w-]+))/gi;for(let s of n)for(let c of["term","sub-term","notes"])s[c]&&(s[c]=s[c].replace(o,(e,r,t,l)=>r||t||l||""))}function A(n,o){for(let s of n)["term","sub-term","notes"].forEach(c=>{let e=s[c]||"",r={};for(let t of Object.keys(o)){let l=new RegExp(`\\!\\b${C(t)}\\b`,"gi");e=e.replace(l,i=>{let a=`temp_placeholder_${t.toUpperCase()}`;return r[a]=i.slice(1),a})}for(let[t,l]of Object.entries(o)){let i=new RegExp(`\\b${C(t)}\\b`,"gi");e=e.replace(i,a=>U(a,l))}for(let[t,l]of Object.entries(r)){let i=new RegExp(C(t),"g");e=e.replace(i,l)}s[c]=e})}function M(n){let o=[];for(let s of n){let c=(s.term||"").trim(),e=(s["sub-term"]||"").trim();if(!(c.includes("<>")||e.includes("<>"))){o.push(s);continue}let t=c.replace(/<>/g,"").trim(),l=e.replace(/<>/g,"").trim();o.push({...s,term:t,"sub-term":l,_ignore:s._ignore||!1}),o.push({...s,term:l,"sub-term":t,_ignore:s._ignore||!1})}return o}function P(n){let o=[];for(let s of n){let e=["term","sub-term","notes","book","page"].map(p=>{let d=s[p]||"";return d.includes("&&")?d.split("&&").map(u=>u.trim()):[d.trim()]}),[r,t,l,i,a]=e;for(let p of r)for(let d of t)for(let u of l)for(let g of i)for(let m of a)o.push({term:p,"sub-term":d,notes:u,book:g,page:m,_ignore:s._ignore||!1})}return o}function j(n){let o={};n.forEach((s,c)=>{if(!s._ignore){for(let e of["term","sub-term","notes","book","page"]){let r=(s[e]||"").trim();(e==="term"&&r===""||r==="^^")&&(s[e]=o[e]||"")}o={...s}}})}function N(n){let o=[],s={term:"",subTerm:"",notes:"",book:0,page:""};for(let c of n){if(c._ignore)continue;let e=(c.term||"").trim(),r=(c["sub-term"]||"").trim(),t=(c.notes||"").trim(),l=(c.book||"").trim(),i=(c.page||"").trim(),a=e!=="",p=r!=="",d=t!=="",u=l!=="",g=i!=="",m=e,b=r,_=t,y=u?parseInt(l):0,w=g?S(i):s.page;a&&!p&&!d&&!u&&!g?(m=e,b="",_="",y=s.book,w=s.page):!a&&p&&!d&&!u&&!g?(m=s.term,b=r,_="",y=s.book,w=s.page):(m=e,b=r,_=t,y=u?parseInt(l):s.book,w=g?S(i):s.page);let $={term:m,subTerm:b,notes:_,book:y,page:w};o.push($),s=$}return o.sort((c,e)=>{let r=k(c.term).localeCompare(k(e.term));if(r!==0)return r;let t=k(c.subTerm).localeCompare(k(e.subTerm));if(t!==0)return t;let l=E(c.page),i=E(e.page);return l-i}),o}function x(n,o){document.getElementById("export_csv_button").onclick=()=>R(n),document.getElementById("export_excel_button").onclick=()=>B(n);let s=document.createElement("table"),c=[];if(o){let e=0;for(;e<n.length;){let r=n[e];if(r.divider){c.push(`
    <tr class="divider-row">
      <td colspan="5"><strong>${r.divider}</strong></td>
    </tr>
  `),e++;continue}let t=n.slice(e).filter(i=>i.term===r.term),l=t.length;for(let i=0;i<l;){let a=n[e+i],d=t.slice(i).filter(m=>m.subTerm===a.subTerm).length,u=i===0?`<td rowspan="${l}">${f(a.term)}</td>`:"",g=d>1?`<td rowspan="${d}">${f(a.subTerm)}</td>`:`<td>${f(a.subTerm)}</td>`;c.push(`
          <tr>
            ${u}
            ${g}
            <td>${f(a.notes)}</td>
            <td>${a.book}</td>
            <td>${v(f(a.page))}</td>


          </tr>
        `);for(let m=1;m<d;m++){let b=n[e+i+m];c.push(`
            <tr>
              <td>${f(b.notes)}</td>
              <td>${b.book}</td>
              <td>${b.page}</td>
            </tr>
          `)}i+=d}e+=l}}else n.forEach(e=>{if(e.divider){c.push(`
      <tr class="divider-row">
        <td colspan="5"><strong>${e.divider}</strong></td>
      </tr>
    `);return}c.push(`
        <tr>
          <td>${f(e.term)}</td>
          <td>${f(e.subTerm)}</td>
          <td>${f(e.notes)}</td>
          <td>${e.book}</td>
          <td>${v(f(e.page))}</td>


        </tr>
      `)});s.innerHTML=`
    <thead>
      <tr><th>Term</th><th>Sub-term</th><th>Notes</th><th>Book</th><th>Page</th></tr>
    </thead>
    <tbody>
      ${c.join("")}
    </tbody>
  `,document.getElementById("output").innerHTML="",document.getElementById("output").appendChild(s)}function U(n,o){let s=n===n.toUpperCase(),c=n[0]===n[0].toUpperCase(),e=o.split(/\b/),r=!1;return e.map(t=>/[A-Z]{2,}/.test(t)?t:s?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():c&&!r&&/[a-zA-Z]/.test(t)?(r=!0,t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()):t.toLowerCase()).join("")}function v(n){return n.split(",").map(o=>`<span class="page-segment">${o.trim()}</span>`).join(", ")}function S(n){return n?n.split(",").map(o=>o.trim()).sort((o,s)=>{let c=E(o),e=E(s);return c-e}).join(", "):""}function k(n){return n?n.replace(/\\[`*]/g,"").replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"):""}function E(n){let s=h(String(n||"")).match(/\d+/g);if(!s)return Number.MAX_SAFE_INTEGER;let c=s.map(e=>parseInt(e,10));return Math.min(...c)}function C(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(n){if(!n)return"";let o={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return n=n.replace(/\\`/g,o.backtick).replace(/\\\*/g,o.star),n=n.replace(/`([^`]+?)`/g,"<code>$1</code>").replace(/\*\*\*([^\*]+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^\*]+?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+?)\*/g,"<em>$1</em>"),n=n.replace(new RegExp(o.backtick,"g"),"`").replace(new RegExp(o.star,"g"),"*"),n}function h(n){if(!n)return"";let o={backtick:"__ESC_BACKTICK__",star:"__ESC_STAR__"};return n=n.replace(/\\`/g,o.backtick).replace(/\\\*/g,o.star),n=n.replace(/`([^`]+?)`/g,"$1").replace(/\*\*\*([^\*]+?)\*\*\*/g,"$1").replace(/\*\*([^\*]+?)\*\*/g,"$1").replace(/\*([^\*]+?)\*/g,"$1"),n=n.replace(new RegExp(o.backtick,"g"),"`").replace(new RegExp(o.star,"g"),"*"),n}function z(n){let o=n[0]||"",s=n[1]||"";return o.includes("|")&&s.match(/^(\|?[\s-]+\|?)+$/)}function H(n){let o=["term","sub-term","notes","book","page"],s=n.split(",").map(c=>c.trim().toLowerCase());return o.every(c=>s.includes(c))}function O(){let n=document.getElementById("insert_dividers_button");n?.addEventListener("click",()=>{currentRenderedData.some(r=>r.divider)?(currentRenderedData=currentRenderedData.filter(r=>!r.divider),n.textContent="Insert Letter Dividers"):(currentRenderedData=o(currentRenderedData),n.textContent="Remove Letter Dividers"),x(currentRenderedData,isCollapsed)});function o(e){if(!Array.isArray(e))return e;let r=[],t=null;for(let l of e){if(l._ignore||l.divider){r.push(l);continue}let i=h(l.term).charAt(0).toUpperCase();i!==t&&(r.push({divider:i}),t=i),r.push(l)}return r}function s(){let e=document.getElementById("print_font_size"),r=parseInt(e?.value,10);return Math.max(1,Math.min(200,isNaN(r)?10:r))}document.getElementById("export_csv_button").onclick=()=>R(currentRenderedData),document.getElementById("export_excel_button").onclick=()=>B(currentRenderedData),document.getElementById("toggle_collapse_button").addEventListener("click",()=>{isCollapsed=!isCollapsed,document.getElementById("toggle_collapse_button").textContent=isCollapsed?"Expand duplicate fields":"Collapse Duplicate Fields",x(currentRenderedData,isCollapsed)});function c(){let e=document.getElementById("print_font_size"),r=document.getElementById("increase_font"),t=document.getElementById("decrease_font"),l=document.getElementById("print_button");function i(a){let p=Math.max(1,Math.min(200,parseInt(a,10)||10));e.value=p;let d=`table {font-size: ${p}px;}`;l.setAttribute("onclick",`printJS({printable: 'output', type: 'html', scanStyles: false, css: 'print.css', style: '${d}'})`);let u=document.querySelector("#output table");u&&(u.style.fontSize=`${p}px`)}e.addEventListener("input",()=>i(e.value)),r.addEventListener("click",()=>i(+e.value+1)),t.addEventListener("click",()=>i(+e.value-1)),i(e.value)}c(),window.addEventListener("keydown",e=>{let r=navigator.platform.toUpperCase().indexOf("MAC")>=0;if((r&&e.metaKey||!r&&e.ctrlKey)&&e.key.toLowerCase()==="p"){e.preventDefault();let i=`table {font-size: ${s()}px;}`;printJS({printable:"output",type:"html",scanStyles:!1,css:"print.css",style:i})}}),document.getElementById("create_index_button").addEventListener("click",()=>{document.getElementById("export_csv_button").style.display="inline-block",document.getElementById("export_excel_button").style.display="inline-block",document.getElementById("toggle_collapse_button").style.display="inline-block",document.getElementById("print_button").style.display="inline-block",document.getElementById("font_selector").style.display="inline-block",document.getElementById("insert_dividers_button").style.display="inline-block",document.getElementById("insert_dividers_button").textContent="Insert Letter Dividers",document.getElementById("toggle_collapse_button").textContent="Expand Duplicate Fields";let e=document.getElementById("index_input").value,r=J(e);currentRenderedData=r,isCollapsed=!0,x(currentRenderedData,isCollapsed)})}function I(n,o){let s=n.filter(t=>!t.divider),c=[],e=null,r=null;for(let t of s){let l=t.term===e?"":t.term,i=t.term===e&&t.subTerm===r?"":t.subTerm;c.push({term:l,subTerm:i,notes:t.notes,book:t.book,page:t.page}),e=t.term,r=t.subTerm}return c}function R(n){let o=I(n,isCollapsed),c=[["Term","Sub-term","Notes","Book","Page"],...o.map(l=>[h(l.term),h(l.subTerm),h(l.notes),l.book,l.page])].map(l=>l.map(i=>`"${String(i).replace(/"/g,'""')}"`).join(",")).join(`
`),e=new Blob([c],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(e),t=document.createElement("a");t.href=r,t.download="index.csv",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function B(n){let o=I(n,isCollapsed),s=[["Term","Sub-term","Notes","Book","Page"],...o.map(r=>[h(r.term),h(r.subTerm),h(r.notes),r.book,r.page])],c=XLSX.utils.aoa_to_sheet(s),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,c,"Index"),XLSX.writeFile(e,"index.xlsx")}function T(n){let o=[],s="",c=!1,e=0;for(;e<n.length;){let r=n[e];c?r==='"'?n[e+1]==='"'?(s+='"',e+=2):(c=!1,e++):(s+=r,e++):r==='"'?(c=!0,e++):r===","?(o.push(s.trim()),s="",e++):(s+=r,e++)}return o.push(s.trim()),o}function X(n,o=!0){let s=n.trim().split(`
`).map(t=>t.trim());if(s.length<1)return[];let c,e;return o?(c=T(s[0]),e=s.slice(1)):(c=["term","sub-term","notes","book","page"],e=s),e.map(t=>{let l=T(t),i={};return c.forEach((p,d)=>{i[p]=l[d]||""}),(i.term?.trim()||"").startsWith("?")&&(i._ignore=!0),i})}function J(n,o={}){let s=n.trim(),c=s.split(`
`),e=o.format||(s.includes(",")&&!s.includes("|")?"csv":"markdown"),r="hasHeaders"in o?o.hasHeaders:e==="markdown"?z(c):H(c[0]),t;e==="markdown"?t=L(s,r):e==="csv"&&(t=X(s,r));let l=D(t);F(t),A(t,l),j(t);let i=M(t),a=P(i);return N(a)}typeof document<"u"&&O();
